#!/bin/bash

dockerImage=$(awk 'NR==1 {print $2}' Dockerfile)
echo $dockerImage
docker run --rm -v $WORKSPACE:/root/.cache/ aquasec/trivy:0.39.0 -q image --exit-code 0 --light $dockerImage
docker run --rm -v $WORKSPACE:/root/.cache/ aquasec/trivy:0.39.0 -q image --exit-code 1 --severity CRITICAL --light $dockerImage

exitCode=$?
echo "Exit code: $exitCode"

if [[ "$exitCode" == 1 ]]; then
  echo "Image scanning failed. Vulnerabilities found"
  exit 1;
else
  echo "Image scanning ok. No CRITICAL Vulnerabilities found"
fi;